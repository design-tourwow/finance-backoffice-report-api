<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö... - Tourwow</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Kanit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #4a7ba7 0%, #2c5f8d 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #333;
      }

      .auth-container {
        text-align: center;
        background: white;
        padding: 3rem 2rem;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }

      .logo {
        margin-bottom: 2rem;
      }

      .logo img {
        max-width: 200px;
        height: auto;
      }

      .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 1.5rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4a7ba7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      h1 {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      p {
        color: #666;
        font-size: 0.95rem;
      }

      .error-message {
        display: none;
        background: #fee;
        color: #c33;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .error-message.show {
        display: block;
      }

      .btn-retry {
        display: none;
        margin-top: 1rem;
        padding: 0.75rem 2rem;
        background: #4a7ba7;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Kanit', sans-serif;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-retry:hover {
        background: #3a6a8f;
      }

      .btn-retry.show {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="logo">
        <img src="https://financebackoffice-staging2.tourwow.com/assets/images/tourwow-logo.png" alt="Tourwow Logo" />
      </div>
      
      <div class="spinner"></div>
      
      <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</h1>
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
      
      <!-- Debug Info -->
      <div id="debugInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; text-align: left; font-size: 12px; font-family: monospace; max-width: 100%; overflow-x: auto;">
        <div style="font-weight: bold; margin-bottom: 10px; color: #333;">üîç Debug Information:</div>
        <div id="debugContent"></div>
      </div>
      
      <div class="error-message" id="errorMessage">
        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏´‡∏£‡∏∑‡∏≠ Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      </div>
      
      <button class="btn-retry" id="btnRetry" onclick="redirectToLogin()">
        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
      </button>
    </div>

    <script>
      (function() {
        'use strict';

        // Get token from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        console.log('üîê Auth page loaded');
        console.log('üìç Current URL:', window.location.href);
        console.log('üé´ Token received:', token ? 'Yes (length: ' + token.length + ')' : 'No');

        if (token && token.trim() !== '') {
          try {
            // Clear all existing tokens first to prevent conflicts
            sessionStorage.clear();
            localStorage.clear();
            console.log('üßπ Cleared sessionStorage and localStorage');
            
            // Store NEW token in BOTH sessionStorage (for API) and localStorage (for debugging)
            sessionStorage.setItem('authToken', token);
            localStorage.setItem('authToken_debug', token);
            localStorage.setItem('authToken_receivedAt', new Date().toISOString());
            localStorage.setItem('authToken_fromURL', window.location.href);
            
            console.log('üì• Token received from URL:', token);
            console.log('üìè Token length:', token.length);
            console.log('üîë Token preview:', token.substring(0, 50) + '...' + token.substring(token.length - 10));
            
            // Verify token was stored correctly
            const storedSessionToken = sessionStorage.getItem('authToken');
            const storedLocalToken = localStorage.getItem('authToken_debug');
            
            if (storedSessionToken === token && storedLocalToken === token) {
              console.log('‚úÖ Token stored successfully in sessionStorage');
              console.log('‚úÖ Token stored successfully in localStorage (debug)');
              
              // Decode and log token expiry for debugging
              try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expDate = new Date(payload.exp * 1000);
                console.log('‚è∞ Token expires at:', expDate.toLocaleString('th-TH'));
                console.log('üìä Token payload:', payload);
              } catch (e) {
                console.log('‚ö†Ô∏è Could not decode token expiry:', e.message);
              }
            } else {
              throw new Error('Token verification failed - stored token does not match');
            }

            // Detect environment from hostname
            const hostname = window.location.hostname;
            let environment = 'production';
            
            if (hostname.includes('staging')) {
              environment = 'staging';
            }
            
            console.log('üéØ Environment detected:', environment);
            console.log('üîÑ Redirecting to tour-image-manager...');

            // Show debug info on screen
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            if (debugInfo && debugContent) {
              debugContent.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Token from URL:</strong><br/>${token.substring(0, 80)}...</div>
                <div style="margin-bottom: 8px;"><strong>Token length:</strong> ${token.length}</div>
                <div style="margin-bottom: 8px;"><strong>Stored in sessionStorage:</strong> ‚úÖ</div>
                <div style="margin-bottom: 8px;"><strong>Stored in localStorage (debug):</strong> ‚úÖ</div>
                <div style="margin-bottom: 8px;"><strong>Environment:</strong> ${environment}</div>
                <div style="margin-bottom: 8px;"><strong>Redirecting in:</strong> <span id="countdown">0.8</span>s</div>
              `;
              debugInfo.style.display = 'block';
              
              // Countdown
              let countdown = 0.8;
              const countdownEl = document.getElementById('countdown');
              const interval = setInterval(() => {
                countdown -= 0.1;
                if (countdownEl) countdownEl.textContent = countdown.toFixed(1);
                if (countdown <= 0) clearInterval(interval);
              }, 100);
            }

            // Redirect to main page (clean URL) - use full path
            setTimeout(() => {
              const redirectUrl = window.location.origin + '/tour-image-manager';
              console.log('üîó Redirect URL:', redirectUrl);
              window.location.replace(redirectUrl);
            }, 800); // Increased delay to ensure storage completes

          } catch (error) {
            console.error('‚ùå Error storing token:', error);
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Token: ' + error.message);
          }
        } else {
          console.error('‚ùå No token found in URL');
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }

        function showError(message) {
          const spinner = document.querySelector('.spinner');
          const heading = document.querySelector('h1');
          const paragraph = document.querySelector('p');
          const errorMessage = document.getElementById('errorMessage');
          const btnRetry = document.getElementById('btnRetry');

          spinner.style.display = 'none';
          heading.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          paragraph.style.display = 'none';
          errorMessage.textContent = message;
          errorMessage.classList.add('show');
          btnRetry.classList.add('show');
        }

        window.redirectToLogin = function() {
          // Redirect to main login page based on environment
          const hostname = window.location.hostname;
          let loginUrl = 'https://financebackoffice.tourwow.com/login';
          
          if (hostname.includes('staging')) {
            loginUrl = 'https://financebackoffice-staging2.tourwow.com/login';
          }
          
          console.log('üîô Redirecting to login:', loginUrl);
          window.location.href = loginUrl;
        };

      })();
    </script>
  </body>
</html>
